<html>
<head>
<title>Get Mouse Coordinates</title>
<script src="/socket.io/socket.io.js"></script>
<script>

  //var socket = io.connect('http://maze.nodester.com'); // http://localhost when running locally
    var socket = io.connect('http://localhost'); //  http://maze.nodester.com')


  var name = prompt('What is your nickname?', 'Write your name');
  var connected = false;
  var mazeWriter = false;

  socket.on('connect', function () {
  	if(!connected){
    	socket.emit('set name', name);
    }

    socket.on('badName', function () {
    name = prompt('That name is ALREADY in use! What is your nickname?', 'Write your name');
      socket.emit('set name', name);
    });

    socket.on('ready', function() {
    	connected = true;
    	mazeWriter = false;
    	console.log("Please be patient; you'll be able to play as soon as an opponent arrives and joins your game!");
    });

    socket.on('inGame', function() {
    	connected = true;
    	mazeWriter = true; // set the second player to join a game to be the maze writer, not the maze traverser
    	console.log("You've joined a game!");
    });

    socket.on('newPlayer', function(id) {
    	console.log("An opponent has joined your game at last!");
    	socket.emit('setOtherPlayer', {n:name, otherID:id});
    	clearCanvas();
    	mouseDown = false;
		old_xy = [];
    });

    socket.on('drawLine',function(coord) {
    	 drawContinuous(coord.x1,coord.y1,coord.x2,coord.y2, 'red');
    	//drawPoint(coord.x2,coord.y2,'red');
    });

  });



</script>
<script language="javascript">





var divObj;
var old_xy = [];
//http://vijayk.wordpress.com/2006/12/11/how-to-get-mouse-coordinates-with-javascript/
/**
* capture mousemove event, this statement will cause browser to
* call getMouseCoordites function each time mouse moves
*/

var mouseDown = false;
document.onmousedown=downMouse;
document.onmouseup=upMouse;

function downMouse() {
	mouseDown = true;
}
function upMouse() {
	if(mazeWriter) {
		mouseDown = false;
		
		if(inputMode == 'line'){
			getMouseCoordinates('up');
		}
		old_xy = [];
		socket.emit('clear_xy',name);
		firstMouseDown = true;

	}
}

var inputMode = 'drag'; //'drag'||'line'
var firstMouseDown = true; //user for line mode only;
document.onmousemove=getMouseCoordinates;

function setMode(mode) {
	if(mazeWriter){
		inputMode = mode;
		alert('input mode has been set to'+ mode);
	}
	else{
		alert('you are not the mazeWriter, No cheating! ')
	}
}

if(inputMode == 'drag'){
	document.onmousemove=getMouseCoordinates;
}
else if(inputMode == 'line'){
	document.onmouseup=getLineMouseCoordinates;
}

/**
*identify which event is supported
* Based on that collect pageX and pageY properties of the event object
* pageX and pageY gets the X and Y cursor coordinates
*/
function getMouseCoordinates(event) {
	if(event == 'up'  || firstMouseDown || mouseDown==true && inputMode == 'drag') {
		ev = window.event;
		firstMouseDown = false;
		divObj.innerHTML = "Mouse X:"+ev.pageX + " Mouse Y:"+ev.pageY;
		oldiv.innerHTML = "Old_xy"+old_xy; 

		// offset calculation needs to change once there are other elements on the page
		// see quirksmode.org/js/findpos.html for details
		var canvas = document.getElementById('can');
		var x = ev.pageX - canvas.offsetLeft;
		var y = ev.pageY - canvas.offsetTop;

		//THIS IS MY SOCKET.IO CODE! LOOK HOW SIMPLE IT IS!
		socket.emit('coord',{x:x, y:y, old_xy:old_xy, n:name}); 

		socket.on('collision', function(msgData) {
	    	if(msgData.collide){
		    	console.log("Collision! Doooooooom! Woe.");
		    } else {
		    	if(msgData.old_xy != []) {
			        drawContinuous(msgData.old_xy[0],msgData.old_xy[1],msgData.current_point[0],msgData.current_point[1],'black');
			    } 	
			    old_xy = [msgData.current_point[0],msgData.current_point[1]];
		    }
	    });
	}
}

function getPoint() {
		ev = window.event;
		divObj.innerHTML = "Mouse X:"+ev.pageX + " Mouse Y:"+ev.pageY;
		oldiv.innerHTML = "Old_xy"+old_xy; 

		// offset calculation needs to change once there are other elements on the page
		// see quirksmode.org/js/findpos.html for details
		var canvas = document.getElementById('can');
		var x = ev.pageX - canvas.offsetLeft;
		var y = ev.pageY - canvas.offsetTop;

		return {x:x, y:y};
}




//assign the mouseCoord Object to divObj
function loadDiv()
{
divObj = document.getElementById("mouseCoord");
oldiv = document.getElementById("old_xy");

}


</script>


</head>

<body onLoad="loadDiv()" style="background-color:navy;">
<div id="mouseCoord" style="background-color:white;">Mouse Coordinates position will be displayed here.
</div>
<div id="old_xy" style="background-color:white;">old xy displayed here.
</div>
<button onclick="setMode('drag') ">Input Drag</button>
<button onclick="setMode('line') ">Input Line</button>
<br/>
<canvas id="can" width="600" height="600" style="background-color:white; positi"> </canvas>


<script type="text/javascript">
	var canvas = document.getElementById('can');
	function drawContinuous(x1,y1,x2,y2,color){
		if(canvas.getContext){
			var ctx = canvas.getContext('2d');
			ctx.strokeStyle=color;
			ctx.beginPath();
			ctx.moveTo(x1,y1);
			ctx.lineTo(x2,y2);
			ctx.stroke();
		}
	}

	function drawPoint(x,y,color){
		if(canvas.getContext){
			var ctx = canvas.getContext('2d');
			ctx.strokeStyle=color;
			ctx.beginPath();
			dot(ctx,x,y,3,color);
			ctx.stroke();
		}
	}

	function dot(ctx,x,y,rad,color){
		ctx.arc(x,y,rad,0,2*Math.PI,false);
		ctx.fillStyle=color;
		ctx.fill();
	}

	function clearCanvas(){
		if(canvas.getContext){
			var ctx = canvas.getContext('2d');
			ctx.clearRect(0, 0, canvas.width, canvas.height);
		}
	}

	drawContinuous();
</script>
</body>
</html>